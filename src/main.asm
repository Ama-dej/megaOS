.INCLUDE "m328pdef.inc"
.INCLUDE "interrupt.asm"

.CSEG
.EQU CPU_FREQ = 16000000
.EQU BAUD = 9600
.EQU BPS = (CPU_FREQ / 16 / BAUD) - 1
; TODO BUFFER ZA SERICA (AMADEJ)
; TODO BACK SPACE, CR, NL (JAKOB)
START:
	CLI

	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R16, HIGH(RAMEND)
	OUT SPH, R16

	LDI R16, LOW(BPS)
	LDI R17, HIGH(BPS)
	STS UBRR0L, R16
	STS UBRR0H, R17

	LDI R16, (1 << RXEN0) | (1 << TXEN0) | (1 << RXCIE0) | (1 << TXCIE0) | (1 << UDRIE0)
	STS UCSR0B, R16

	SEI

HANG:
	RJMP HANG




LOCI_UKAZ:
	PUSH R16
	PUSH PUSH XL
	PUSH PUSH XH
	PUSH PUSH YL
	PUSH PUSH YH
	LDI XL, LOW("BUFFER_ZACETEK")
	LDI XH, HIGH("BUFFER_ZACETEK")
	LDI YL, LOW(PARAMETER)
	LDI YH, HIGH(PARAMETER)
	LOCI:
		LD R16, X+
		CPI R16, 0x20
		BRNE LOCI
		INC X
	LOCI2:
		LD R16,X+
		CPI R16, 0x00
		BREQ VRNI
		CPI R16, 0x20
		BREQ LOCI2
		ST Y+, R16
		RJMP LOCI2
	VRNI:
		POP YH
		POP YL
		POP XH
		POP XL
		POP R16
		RET


.DSEG
PARAMETER:  .BYTE 20